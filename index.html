<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Algae-Market ‚Äî Algae</title>
<style>
  :root{
    --bg:#0e1111; --card:#151a1a; --muted:#8aa29e; --text:#eef3f2; --brand:#39d98a; --brand-2:#2bb673; --danger:#ff5c6c;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:linear-gradient(180deg,#0c0f0f,#0f1313);}
  header{position:sticky;top:0;background:rgba(42, 44, 44, 0.9);backdrop-filter:blur(8px);z-index:10;border-bottom:1px solid #1d2323}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .nav{display:flex;align-items:center;gap:16px;justify-content:space-between;color:var(--text)}
  .logo{display:flex;align-items:center;gap:10px;font-weight:700}
  .logo i{width:28px;height:28px;border-radius:8px;background:radial-gradient(120% 120% at 20% 20%,#55ffa8,transparent 60%),radial-gradient(120% 120% at 80% 80%,#2bb673,transparent 60%),#1a221f;box-shadow:0 0 24px rgba(57,217,138,.35) inset}
  .tag{font-size:12px;color:var(--muted)}
  .btn{cursor:pointer;border:none;border-radius:12px;padding:10px 14px;background:var(--brand);color:#052d1b;font-weight:700}
  .btn:hover{background:var(--brand-2)}
  .btn.ghost{background:transparent;color:var(--text);border:1px solid #2a3434}
  .btn.danger{background:var(--danger);color:#2a0a0e}
  main .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
  .card{background:var(--card);color:var(--text);border:1px solid #1d2323;border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
  .card img{width:100%;height:160px;object-fit:cover;background:#0b0f0f}
  .card .pad{padding:14px;display:flex;flex-direction:column;gap:8px}
  .muted{color:var(--muted);font-size:14px}
  .drawer{position:fixed;right:0;top:0;height:100%;width:420px;max-width:95vw;background:var(--card);border-left:1px solid #1d2323;transform:translateX(100%);transition:.25s ease;z-index:100}
  .drawer.open{transform:translateX(0)}
  .drawer header{position:sticky;top:0;background:var(--card)}
  .drawer .content{padding:16px;height:calc(100% - 64px);overflow:auto;display:flex;flex-direction:column;gap:16px}
  .cart-item{display:grid;grid-template-columns:64px 1fr auto;gap:10px;align-items:center;border:1px solid #ffffff;border-radius:12px;padding:8px}
  .cart-item img{width:64px;height:64px;object-fit:cover;border-radius:8px}
  .qty{display:flex;align-items:center;background:#0f1313;border:1px solid #1f2525;border-radius:8px}
  .qty button{background:transparent;color:var(--text);border:none;padding:6px 10px;cursor:pointer}
  .qty input{width:40px;text-align:center;background:transparent;color:var(--text);border:none}
  .total{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-top:1px solid #1d2323;margin-top:8px;color:var(--text)}
  form.checkout{display:flex;flex-direction:column;gap:10px;background:#101515;border:1px solid #1d2323;padding:12px;border-radius:12px}
  form.checkout input, form.checkout textarea, form.checkout select{width:100%;padding:10px;border-radius:10px;border:1px solid #1f2525;background:#0c1010;color:var(--text)}
  .inline{display:flex;gap:10px}
  .inline>*{flex:1}
  .alert{padding:10px;border-radius:10px;background:#0f1412;border:1px solid #1a2a23;color:#94d6b4}
  .confirm{background:rgba(24,34,30,.9);border:1px solid #20352c;color:#baf3d0;padding:12px;border-radius:12px}
  @media (max-width:520px){.inline{flex-direction:column}}
  .row{display:flex;gap:8px;align-items:center;justify-content:space-between}
  /* =========================
   Cart readability overrides
   ========================= */
.drawer .cart-item{
  background:#fff;                 /* white card */
  color:#0e1111;                   /* dark text */
  border:1px solid #e5e7eb;        /* light border */
  box-shadow:0 2px 10px rgba(0,0,0,.06);
}
.error { color: var(--danger, #ff5c6c); font-size: 12px; display:block; margin-top:6px; }


.drawer .cart-item .muted{
  color:#444;                      /* readable secondary text */
}

/* quantity control on light background */
.drawer .cart-item .qty{
  background:#ffffff;
  border:1px solid #e5e7eb;
}
.drawer .cart-item .qty button,
.drawer .cart-item .qty input{
  color:#0e1111;                   /* dark text for +/- and number */
}
.drawer .cart-item .qty input{
  background:transparent;
}

/* price text inside each item */
.drawer .cart-item > div:last-child > div:first-child{
  color:#0e1111;
}

/* make sure images stay vibrant */
.drawer .cart-item img{
  filter:none; opacity:1;
}
/* --- Single-product layout: narrow & centered --- */
#productGrid.single {
  max-width: 380px;         /* how narrow you want the section */
  margin-inline: auto;      /* center the section */
  grid-template-columns: 1fr;
  justify-items: center;
}

/* cap card width in all cases so it never becomes too wide */
#productGrid .card {
  width: 100%;
  max-width: 360px;         /* card width cap; adjust to taste */
}

/* (optional) make the product image a bit shorter so the card feels tighter */
#productGrid .card img {
  height: 140px;            /* was 160px */
}
/* Waitlist modal styles */
.wl-modal{
  position:fixed;inset:0;display:grid;place-items:center;
  background:rgba(0,0,0,.6);backdrop-filter:blur(4px);
}
/* Ensure hidden attribute wins even if a component sets display */
[hidden] { display: none !important; }

.wl-card{
  width:min(420px,92vw);background:var(--card,#151a1a);
  color:var(--text,#eef3f2);border:1px solid #1d2323;border-radius:16px;
  padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.4)
}
.wl-row{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
.wl-row input{
  background:#0f1313;color:var(--text,#eef3f2);border:1px solid #2a2f2f;
  padding:10px;border-radius:10px;outline:none
}
.wl-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
#wlCancel{background:#2a2f2f;color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
#wlSubmit{background:var(--brand,#39d98a);color:#0b0f0f;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
.wl-msg{min-height:1.25rem;margin-top:8px;color:var(--muted,#8aa29e);font-size:.9rem}
.btn-waitlist{
  background:linear-gradient(180deg,var(--brand,#39d98a),var(--brand-2,#2bb673));
  color:#0b0f0f;border:none;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:700
}


</style>
</head>
<body>
<header>
  <div class="wrap nav">
    <div class="logo"> <img src="logo.png" >Algae-Market <span class="tag"></span></div>
    <div style="display:flex;gap:8px">
      <button class="btn ghost" id="openCart">Cart (<span id="cartCount">0</span>)</button>
      <span id="powderRemainBadge" class="tag" style="margin-left:8px"> </span>
      
    </div>
    
  </div>
</header>

<main class="wrap" style="padding:20px 16px 60px">
  <section style="margin:8px 0 20px;color:var(--text)">
    <h1 style="margin:.2em 0">Algae Biomass</h1>
    <p class="muted"></p>
  </section>

  <section class="grid" id="productGrid"></section>
</main>

<div class="drawer" id="cartDrawer" aria-hidden="true">
  <header class="wrap nav" style="padding:12px 16px">
    <strong>üß∫ Your Cart</strong>
    <button class="btn ghost" id="closeCart">Close</button>
  </header>
  <div class="content">
    <div id="cartList" style="display:flex;flex-direction:column;gap:10px"></div>

    <div class="total">
      <div>Subtotal</div>
      <div><strong id="subtotal">EGP 0.00</strong></div>
    </div>

    <div class="alert">Payment method: <strong>Cash on Delivery</strong> only.</div>

    <form class="checkout" id="checkoutForm">
      <div class="inline">
        <input required name="name" placeholder="Full name" />
        <input required name="phone" placeholder="Phone (WhatsApp)" />
      </div>
      <div class="inline">
        <input required name="city" placeholder="City" />
        <input type="email" name="email" placeholder="Email (optional, for receipt)" />
      </div>
      <textarea required name="address" rows="3" placeholder="Full address (street, building, floor, landmark)"></textarea>
      <input name="notes" placeholder="Notes (optional)" />
      <div class="inline">
        <!-- find your submit button and give it an id -->
        <button class="btn" type="submit" id="placeOrderBtn">Place Order (COD)</button>

        <button type="button" class="btn ghost" id="emailOrder">Email this order</button>
        <button type="button" class="btn ghost" id="whatsOrder">Chat via WhatsApp</button>
      </div>
      <div id="confirmBox" class="confirm" style="display:none" aria-live="polite"></div>
    </form>
  </div>
</div>


<script>
/* =========================
   CONFIG ‚Äî EDIT THESE
========================= */
const BUSINESS_WHATSAPP = "201096412410"; // your phone in international format, no +
const BUSINESS_EMAIL    = "algaemarketdotcom@gmail.com"; // your email (mailto fallback)
const SHEETS_WEBHOOK    = "https://script.google.com/macros/s/AKfycbyqozhJgTpbg-R7_xxpvYncqlBd64Vf5_i4yMz3SYiU0dmOPIoAYRMfpYoCrR4_vE7ZyQ/exec"; // Apps Script URL
const CURRENCY          = "EGP";

/**
 * VARIANT DEFINITIONS  
 */
const PRODUCTS = [
 /* {
    id: "POWDER-GRAMS",
    name: "Algae Fertilizer Powder (grams)",
    img: "https://images.unsplash.com/photo-1523654885119-cd74663cbf18?q=80&w=1200&auto=format&fit=crop",
    variants: [
      //{ id:"50g",  label:"50 g",  unit:"g",  qty:50,  price:  80 },
      { id:"100g", label:"100 g", unit:"g",  qty:100, price: 140 },
      { id:"200g", label:"200 g", unit:"g",  qty:200, price: 250 },
      { id:"500g", label:"500 g", unit:"g",  qty:500, price: 560 }
    ]
  },*/
  {
    id: "POWDER-KG",
    name: "Chlorella Dried Powder - (ŸÉŸÑŸàÿ±ŸäŸÑÿß ÿ®ŸàÿØÿ±Ÿá ŸÖÿ¨ŸÅŸÅŸá) not for human consumption",
    img: "chol3.jpg",
    variants: [
        { id:"100g", label:"100 g", unit:"g",  qty:100, price: 250 },
      { id:"1kg",  label:"1 kg",  unit:"kg", qty:1,  price: 1500 },
      //{ id:"2kg",  label:"2 kg",  unit:"kg", qty:2,  price: 420 },
     // { id:"5kg",  label:"5 kg",  unit:"kg", qty:5,  price: 7500 },
     // { id:"10kg", label:"10 kg", unit:"kg", qty:10, price:15000 },
      //{ id:"20kg", label:"20 kg", unit:"kg", qty:20, price:3390 },
      //{ id:"25kg", label:"25 kg", unit:"kg", qty:25, price:4100 },
      //{ id:"50kg", label:"50 kg", unit:"kg", qty:50, price:7700 }
    ]
  },
  
];
// =========================
// INVENTORY ‚Äî POWDER (grams)
// =========================

// LS keys

// initialize remaining stock once




/* =========================
   HELPERS
========================= */
function isPowderProduct(pid){
  return pid === "POWDER-GRAMS" || pid === "POWDER-KG";
}
function variantGrams(product, variant){
  // only powder contributes to this inventory
  if(!isPowderProduct(product.id)) return 0;
  if(variant.unit === "g") return variant.qty;
  if(variant.unit === "kg") return variant.qty * 1000;
  return 0;
}
function cartPowderGrams(){
  return state.cart.reduce((sum,i)=>{
    const p = productById(i.pid); const v = variantById(p, i.vid);
    return sum + variantGrams(p, v) * i.qty;
  }, 0);
}
function orderPowderGrams(items){
  return items.reduce((sum,x)=>{
    if(isPowderProduct(x.productId)){
      // x.packQty is units per pack; unit is in x.unit
      const gramsPerPack = (x.unit === "g" ? x.packQty : (x.unit === "kg" ? x.packQty*1000 : 0));
      return sum + gramsPerPack * x.packs;
    }
    return sum;
  }, 0);
}
function deductPowderStock(grams){
  const remain = getPowderRemain();
  setPowderRemain(Math.max(0, remain - (grams|0)));
  renderPowderRemain();
}

const $  = sel => document.querySelector(sel);
const fmt = n => `${CURRENCY} ${Number(n||0).toFixed(2)}`;
function productById(pid){ return PRODUCTS.find(p=>p.id===pid); }
function variantById(product, vid){ return product.variants.find(v=>v.id===vid); }

/* =========================
   STATE + PERSISTENCE
========================= */
const state = {
  cart: JSON.parse(localStorage.getItem("cart") || "[]"),
  lastOrder: null,       // last submitted order (for WhatsApp/Email buttons)
  lastOrderText: ""
};
function persist(){ localStorage.setItem("cart", JSON.stringify(state.cart)); }



/* =========================
   CART OPS
========================= */
function addToCart(pid, vid){
  const p = productById(pid);
  const v = variantById(p, vid);

  // check powder stock
  if(isPowderProduct(pid)){
    const need = variantGrams(p, v);
    const remain = getPowderRemain();
    const inCart = cartPowderGrams();
    if(need > Math.max(0, remain - inCart)){
      alert("Not enough powder remaining for this variant.");
      recheckAddButton(pid);
      return;
    }
  }

  const found = state.cart.find(i=>i.pid===pid && i.vid===vid);
  if(found){
    // increasing by one pack -> verify
    if(isPowderProduct(pid)){
      const extra = variantGrams(p, v);
      const remain = getPowderRemain();
      const inCart = cartPowderGrams();
      if(extra > Math.max(0, remain - inCart)){
        alert("Not enough powder remaining to add another pack.");
        return;
      }
    }
    found.qty += 1;
  } else {
    state.cart.push({ pid, vid, qty:1 });
  }
  persist(); renderCart(); pulse($('#openCart'));
  // refresh buttons availability text for all powder products
  PRODUCTS.forEach(x=> isPowderProduct(x.id) && recheckAddButton(x.id));
}

function removeFromCart(pid, vid){
  state.cart = state.cart.filter(i=>!(i.pid===pid && i.vid===vid));
  persist(); renderCart();
  PRODUCTS.forEach(x=> isPowderProduct(x.id) && recheckAddButton(x.id));
}

function updateQty(pid, vid, n){
  const item = state.cart.find(i=>i.pid===pid && i.vid===vid);
  if(!item) return;
  const newQty = Math.max(1, n|0);

  const p = productById(pid);
  const v = variantById(p, vid);

  if(isPowderProduct(pid)){
    // compute what grams would be *if* we set to newQty
    const currentInCart = cartPowderGrams();
    const itemCurrentGrams = variantGrams(p, v) * item.qty;
    const itemNewGrams = variantGrams(p, v) * newQty;
    const projected = currentInCart - itemCurrentGrams + itemNewGrams;

    if(projected > getPowderRemain()){
      alert("Quantity exceeds powder inventory.");
      return;
    }
  }

  item.qty = newQty;
  persist(); renderCart();
  PRODUCTS.forEach(x=> isPowderProduct(x.id) && recheckAddButton(x.id));
}
function subtotal(){
  return state.cart.reduce((s,i)=>{
    const p = productById(i.pid);
    const v = variantById(p, i.vid);
    return s + (v.price * i.qty);
  }, 0);
}
function pulse(el){ el.style.transform='scale(1.05)'; setTimeout(()=>el.style.transform='',150); }

/* =========================
   RENDER ‚Äî PRODUCTS
========================= */
function renderProducts(){
  const grid = $("#productGrid");
  grid.innerHTML = PRODUCTS.map(p => {
    const options = p.variants.map(v=>`<option value="${v.id}">${v.label} ‚Äî ${fmt(v.price)}</option>`).join('');
    const btnId = `btn-${p.id}`;
    const selId = `sel-${p.id}`;

    return `
    <article class="card">
      <img src="${p.img}" alt="${p.name}" loading="lazy"/>
      <div class="pad">
        <div class="row">
          <div>
            <div style="font-weight:700">${p.name}</div>
            <div class="muted">ID: ${p.id}</div>
          </div>
        </div>
        <select id="${selId}" aria-label="Choose quantity" onchange="recheckAddButton('${p.id}')">
          ${options}
        </select>
        <button id="${btnId}" class="btn" onclick="addToCart('${p.id}', document.getElementById('${selId}').value)">Add to Cart</button>
    


        
      </div>
    </article>`;
  }).join('');
  // after rendering, update availability states
  PRODUCTS.forEach(p=>{
    if(isPowderProduct(p.id)){
      const remainEl = document.getElementById(`remain-${p.id}`);
      if(remainEl) remainEl.textContent = getPowderRemain();
      recheckAddButton(p.id);
    }
  });
}
function recheckAddButton(pid){
  const sel = document.getElementById(`sel-${pid}`);
  const btn = document.getElementById(`btn-${pid}`);
  if(!sel || !btn) return;

  // while inventory is loading, keep powder buttons disabled
  if (isPowderProduct(pid) && !INV_READY) {
    btn.disabled = true;
    btn.textContent = "Checking stock‚Ä¶";
    return;
  }

  const p = productById(pid);
  const v = variantById(p, sel.value);
  const need = variantGrams(p, v);

  const remain = getPowderRemain();
  const inCart = cartPowderGrams();
  const free = Math.max(0, remain - inCart);

  const ok = !isPowderProduct(pid) || need <= free;
  btn.disabled = !ok;
  btn.textContent = ok ? "Add to Cart" : "Out of Stock";
}

/* =========================
   RENDER ‚Äî CART
========================= */
function renderCart(){
  $("#cartCount").textContent = state.cart.reduce((s,i)=>s+i.qty,0);
  const list = $("#cartList");
  if(state.cart.length===0){
    list.innerHTML = `<div class="muted">Your cart is empty.</div>`;
    $("#subtotal").textContent = fmt(0);
    renderPowderRemain();
    PRODUCTS.forEach(x=> isPowderProduct(x.id) && recheckAddButton(x.id));
    return;
  }
  list.innerHTML = state.cart.map(i=>{
    const p = productById(i.pid);
    const v = variantById(p, i.vid);
    const line = v.price * i.qty;
    return `
      <div class="cart-item">
        <img src="${p.img}" alt="${p.name}"/>
        <div>
          <div style="font-weight:700">${p.name}</div>
          <div class="muted">Variant: ${v.label} ‚Äî ${fmt(v.price)} each</div>
          <div class="qty" aria-label="quantity of packs">
            <button onclick="updateQty('${i.pid}','${i.vid}', ${i.qty-1})">‚àí</button>
            <input value="${i.qty}" oninput="updateQty('${i.pid}','${i.vid}', this.value)" />
            <button onclick="updateQty('${i.pid}','${i.vid}', ${i.qty+1})">+</button>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
          <div>${fmt(line)}</div>
          <button class="btn danger" onclick="removeFromCart('${i.pid}','${i.vid}')">Remove</button>
        </div>
      </div>
    `;
  }).join('');
  $("#subtotal").textContent = fmt(subtotal());
}

/* =========================
   CHECKOUT (COD) + LOGGING
========================= */
function orderId(){
  const d = new Date();
  const pad = n => String(n).padStart(2,'0');
  return `GB-${String(d.getFullYear()).slice(2)}${pad(d.getMonth()+1)}${pad(d.getDate())}-${Math.random().toString(36).slice(2,6).toUpperCase()}`;
}
function orderPayload(form){
  const data = Object.fromEntries(new FormData(form));
  const items = state.cart.map(i=>{
    const p = productById(i.pid);
    const v = variantById(p, i.vid);
    return {
      productId: p.id,
      productName: p.name,
      variantId: v.id,
      variantLabel: v.label,
      unit: v.unit,
      packQty: v.qty,
      priceEach: v.price,
      packs: i.qty,
      lineTotal: v.price * i.qty
    };
  });
  const total = items.reduce((s,x)=>s+x.lineTotal,0);
  return {
    id: orderId(),
    items, total,
    customer: {
      name: data.name, phone: data.phone, city: data.city,
      address: data.address, notes: data.notes || "", email: data.email || ""
    },
    createdAt: new Date().toISOString(),
    payment: "COD",
    source: "website"
  };
}
function encodeMultiline(obj){
  const lines = [];
  const money = n=>Number(n||0).toFixed(2);
  lines.push(`Order ID: ${obj.id}`);
  lines.push(`Date: ${new Date().toLocaleString()}`);
  lines.push(`Payment: ${obj.payment}`);
  lines.push(``);
  lines.push(`Items:`);
  obj.items.forEach(x=>{
    lines.push(`- ${x.productName} / ${x.variantLabel} x${x.packs} ‚Äî ${CURRENCY} ${money(x.priceEach)} (Line: ${CURRENCY} ${money(x.lineTotal)})`);
  });
  lines.push(``);
  lines.push(`Subtotal: ${CURRENCY} ${money(obj.total)}`);
  lines.push(``);
  lines.push(`Customer: ${obj.customer.name}`);
  lines.push(`Phone: ${obj.customer.phone}`);
  lines.push(`City: ${obj.customer.city}`);
  lines.push(`Address: ${obj.customer.address}`);
  if(obj.customer.email) lines.push(`Email: ${obj.customer.email}`);
  if(obj.customer.notes) lines.push(`Notes: ${obj.customer.notes}`);
  return lines.join('\n');
}
async function logToSheets(order){
  try{
    const data = JSON.stringify(order);
    const blob = new Blob([data], { type: "text/plain;charset=utf-8" });

    // 1) Try sendBeacon (often best for cross-origin, no CORS preflight)
    if (navigator.sendBeacon) {
      const ok = navigator.sendBeacon(SHEETS_WEBHOOK, blob);
      if (ok) return true;
    }

    // 2) Fallback to fetch no-cors with a "simple" content type
    await fetch(SHEETS_WEBHOOK, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: data
    });
    return true;
  } catch(err){
    console.warn("Sheets logging failed:", err);
    return false;
  }
}
// ===== GLOBAL INVENTORY (from Apps Script) =====
let POWDER_REMAIN = 0; // live value for this page
let INV_READY = false;

function getPowderRemain(){ return POWDER_REMAIN; }
function setPowderRemain(_){ /* server owns stock now; no-op */ }

function loadGlobalInventory(){
  const cb = "__inv_cb_" + Math.random().toString(36).slice(2);
  window[cb] = grams => {
    POWDER_REMAIN = Number(grams||0)|0;
    INV_READY = true;  
    renderPowderRemain();
    PRODUCTS.forEach(x=> isPowderProduct(x.id) && recheckAddButton(x.id));
    delete window[cb];
  };
  const s = document.createElement("script"); // JSONP avoids CORS
  s.src = SHEETS_WEBHOOK + "?action=getInv&cb=" + cb;
  document.head.appendChild(s);
}

function renderPowderRemain(){
  const el = document.getElementById("powderRemainText");
  if(el){ el.textContent = getPowderRemain(); }
}


function openWhatsApp(text){
  const url = `https://wa.me/${BUSINESS_WHATSAPP}?text=${encodeURIComponent(text)}`;
  window.open(url, "_blank");
}
function openMailTo(text){
  const subject = encodeURIComponent("New COD Order");
  const body = encodeURIComponent(text);
  window.location.href = `mailto:${BUSINESS_EMAIL}?subject=${subject}&body=${body}`;
}
function showConfirmation(msg){
  const box = $("#confirmBox");
  box.style.display='block';
  box.textContent = msg;
}
function clearCart(){ state.cart = []; persist(); renderCart(); }

/* =========================
   WIRING
========================= */
renderProducts();
renderCart();

renderPowderRemain();

PRODUCTS.forEach(x=> isPowderProduct(x.id) && recheckAddButton(x.id));
loadGlobalInventory();

if (PRODUCTS.length === 1) {
    document.getElementById('productGrid').classList.add('single');
  }

  PRODUCTS.forEach(x=> isPowderProduct(x.id) && recheckAddButton(x.id));
  loadGlobalInventory();

$("#openCart").addEventListener("click", ()=>{
  const d = $("#cartDrawer");
  d.classList.add("open");
  d.setAttribute("aria-hidden","false");
});
$("#closeCart").addEventListener("click", ()=>{
  const d = $("#cartDrawer");
  d.classList.remove("open");
  d.setAttribute("aria-hidden","true");
});
// helper: disable/enable a button
function setBusy(btn, busy=true, labelWhenBusy="Sending..."){
  if(!btn) return;
  btn.disabled = !!busy;
  btn.dataset.orig = btn.dataset.orig || btn.textContent;
  btn.textContent = busy ? labelWhenBusy : btn.dataset.orig;
}

$("#checkoutForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(state.cart.length===0){ alert("Your cart is empty."); return; }

  const btn = document.getElementById("placeOrderBtn");
  setBusy(btn, true);

  try {
    const order = orderPayload(e.target);
    const text  = encodeMultiline(order);
    // === stock snapshot (send to sheet) ===
    const remainBefore = getPowderRemain();
    const needPowder   = orderPowderGrams(order.items);
    const remainAfter  = Math.max(0, remainBefore - needPowder);

    // block oversell (safety)
    if(needPowder > remainBefore){
    alert("Sorry, your cart exceeds the available powder stock. Please reduce quantities.");
    return;
    }

    // attach simple top-level fields (columns in your sheet)
    order.powderRemainBefore = remainBefore;  // grams
    order.powderDeductGrams  = needPowder;    // grams
    order.powderRemainAfter  = remainAfter;   // grams


   

    // send + persist "last order"
    await logToSheets(order);
    state.lastOrder = order;
    state.lastOrderText = text;

    // ‚úÖ commit inventory deduction
  

    showConfirmation(`‚úÖ Order ${order.id} submitted. A separate email and row were created.`);
    clearCart();
    loadGlobalInventory();
  } finally {
    setBusy(btn, false);
    // refresh availability
    renderPowderRemain();
    PRODUCTS.forEach(x=> isPowderProduct(x.id) && recheckAddButton(x.id));
  }
});




$("#emailOrder").addEventListener("click", ()=>{
  const form = $("#checkoutForm");
  // use last order if available, otherwise build a preview from form + current cart
  let text = state.lastOrderText;
  if(!text){
    if(state.cart.length===0){ alert("Fill the form and click Place Order first (or keep items in cart)."); return; }
    if(!form.reportValidity()) return;
    const preview = orderPayload(form);
    text = encodeMultiline(preview);
  }
  openMailTo(text);
});

$("#whatsOrder").addEventListener("click", ()=>{
  const form = $("#checkoutForm");
  let text = state.lastOrderText;
  if(!text){
    if(state.cart.length===0){ alert("Fill the form and click Place Order first (or keep items in cart)."); return; }
    if(!form.reportValidity()) return;
    const preview = orderPayload(form);
    text = encodeMultiline(preview);
  }
  openWhatsApp(text);
});
</script>
    <footer style="text-align:center;color:var(--muted);padding:10px">
  Visitors: <span id="visitorCount">0</span>
</footer>

<script>
(function(){
  const el = document.getElementById('visitorCount');
  if (!el) return;

  // one increment per browser per day (optional)
  const dayKey = 'visCount-' + new Date().toISOString().slice(0,10); // YYYY-MM-DD
  const action = localStorage.getItem(dayKey) ? 'getCounter' : 'hitCounter';

  // build a unique JSONP callback
  const cb = '__vcb_' + Math.random().toString(36).slice(2);
  window[cb] = function(resp){
    try {
      if (resp && resp.ok && typeof resp.value === 'number') {
        el.textContent = resp.value;
        if (action === 'hitCounter') localStorage.setItem(dayKey, '1');
      } else {
        el.textContent = '‚Äî';
        console.warn('Counter response:', resp);
      }
    } finally {
      delete window[cb];
      scr && scr.remove && scr.remove();
    }
  };

  // JSONP <script> ‚Äî uses your existing SHEETS_WEBHOOK
  const scr = document.createElement('script');
  scr.src = `${SHEETS_WEBHOOK}?action=${action}&key=homepage&cb=${cb}`;
  document.head.appendChild(scr);
})();
/***********************
 * WAITLIST ‚Äî Frontend
 ***********************/

/* ===== Waitlist open (delegated) ===== */
function openWaitlistModal(){
  const modal = document.getElementById('waitlistModal');
  const msg   = document.getElementById('wlMsg');
  if (modal) modal.hidden = false;
  if (msg) { msg.textContent = ''; msg.style.color = 'var(--muted,#8aa29e)'; }
}

document.getElementById('productGrid').addEventListener('click', (e)=>{
  const btn = e.target.closest('.waitlistBtn');
  if (!btn) return;
  openWaitlistModal();
});

</script>

<!-- Waitlist Modal -->
<div id="waitlistModal" class="wl-modal" hidden>
  <div class="wl-card">
    <h3>Join the Waitlist</h3>
    <form id="waitlistForm">
      <div class="wl-row">
        <label>ÿßŸÑÿßÿ≥ŸÖ</label>
        <input type="text" name="name" required placeholder="Your full name" />
      </div>
      <div class="wl-row">
        <label>ÿßŸÑÿ™ŸÑŸäŸÅŸàŸÜ</label>
        <input
        id="phone"
        name="phone"
        type="tel"
        dir="ltr"
        inputmode="numeric"
        autocomplete="tel"
        placeholder="01012345678"
        required
        />
        <small id="phone-error" class="error" aria-live="polite"></small>
      </div>
      <div class="wl-row">
        <label>ÿßŸÑŸÉŸÖŸäÿ© ÿ®ÿßŸÑŸÉŸäŸÑŸà</label>
        <input type="number" name="quantity" min="1" step="1" required value="1" />
      </div>

      <!-- Honeypot (anti-bot) ‚Äì keep hidden -->
      <input type="text" name="company" tabindex="-1" autocomplete="off" style="position:absolute;left:-99999px;opacity:0" />

      <div class="wl-actions">
        <button type="button" id="wlCancel">Cancel</button>
        <button type="submit" id="wlSubmit">Submit</button>
      </div>
      <p id="wlMsg" class="wl-msg"></p>
    </form>
  </div>
</div>
<script>
(function(){
 const WEBHOOK = SHEETS_WEBHOOK; // reuse your Apps Script URL

  // Use the IDs that exist in your HTML:
  const openBtn = document.getElementById('waitlistBtn');      // button inside card
  const modal   = document.getElementById('waitlistModal');    // <div id="waitlistModal" ...>
  const form    = document.getElementById('waitlistForm');     // <form id="waitlistForm">
  const cancel  = document.getElementById('wlCancel');
  const msg     = document.getElementById('wlMsg');
  const submit  = document.getElementById('wlSubmit');


  function open(){ modal.hidden = false; msg.textContent=''; }
  function close(){ modal.hidden = true; }

  openBtn?.addEventListener('click', open);
  cancel?.addEventListener('click', close);
  modal?.addEventListener('click', (e)=>{ if(e.target===modal) close(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });

  function validate(name, phone, qty){
  if(!name || name.trim().length < 2) return 'Please enter your name.';
  const local = normalizeToEgMobile(phone||'');
  if(!/^01[0125]\d{8}$/.test(local)) return 'Please enter a valid Egyptian mobile (e.g., 01012345678).';
  if(!(qty > 0)) return 'Quantity must be at least 1.';
  return '';
}



  // JSONP caller (avoids CORS; uses doGet)
  function callAddWaitlistJSONP({name, phone, quantity, page}) {
    return new Promise((resolve)=>{
      const cbName = "__wl_cb_" + Math.random().toString(36).slice(2);
      window[cbName] = (payload)=>{
        try { resolve(payload); } finally {
          delete window[cbName];
          s.remove();
        }
      };
      const params = new URLSearchParams({
        action: 'addWaitlist',
        name, phone, quantity: String(quantity),
        page: page || location.href,
        cb: cbName
      });
      const s = document.createElement('script');
      s.src = WEBHOOK + "?" + params.toString();
      document.head.appendChild(s);
    });
  }

  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    msg.style.color = 'var(--muted,#8aa29e)';
    msg.textContent = '';

    const fd = new FormData(form);
    if (fd.get('company')) { msg.textContent = 'Submission blocked.'; return; }

    const name = String(fd.get('name')||'').trim();
    const phone = String(fd.get('phone')||'').trim();
    const quantity = Number(fd.get('quantity')||0);
    const err = validate(name, phone, quantity);
    if (err) { msg.textContent = err; return; }

    submit.disabled = true; const prev = submit.textContent; submit.textContent = 'Submitting‚Ä¶';
    try{
      const res = await callAddWaitlistJSONP({ name, phone, quantity, page: location.href });
      if (res && res.ok) {
        msg.style.color = 'var(--brand,#39d98a)';
        msg.textContent = 'Added! We‚Äôll contact you when stock is back.';
        form.reset();
        setTimeout(close, 1200);
      } else {
        msg.style.color = 'var(--danger,#ff5c6c)';
        msg.textContent = 'Couldn‚Äôt add you. Please try again.';
      }
    } catch {
      msg.style.color = 'var(--danger,#ff5c6c)';
      msg.textContent = 'Network error. Please try again.';
    } finally {
      submit.disabled = false; submit.textContent = prev;
    }
  });
})();

// --- Config ---------------------------------------------------------------
const ALLOW_ARABIC_INPUT = true;                 // accept + auto-convert Arabic digits
const EG_MOBILE_RE = /^01[0125]\d{8}$/;         // 010/011/012/015 + 8 digits

// --- Utils: Arabic/Persian digits ‚Üí ASCII --------------------------------
function normalizeArabicDigits(str) {
  let out = "";
  for (const ch of str) {
    const code = ch.codePointAt(0);
    if (code >= 0x0660 && code <= 0x0669) out += String.fromCharCode(code - 0x0660 + 0x30);
    else if (code >= 0x06F0 && code <= 0x06F9) out += String.fromCharCode(code - 0x06F0 + 0x30);
    else out += ch;
  }
  return out;
}
function keepDigitsPlus(str) {
  str = str.replace(/[^\d+]/g, "");
  if ((str.match(/\+/g) || []).length > 1) str = "+" + str.replace(/[^\d]/g, "");
  return str;
}
// Normalize to Egyptian local format starting with 0
function normalizeToEgMobile(raw) {
  let v = normalizeArabicDigits(raw);
  v = keepDigitsPlus(v);
  v = v.replace(/^\+?0020/, "").replace(/^\+?20/, "");
  if (!v.startsWith("0")) v = "0" + v;
  return v.replace(/\D/g, "");
}

// --- Hook up to the *correct* form ---------------------------------------
const form  = document.querySelector("#waitlistForm");  // <-- fixed id
const phone = document.querySelector("#waitlistForm #phone");
const errEl = document.querySelector("#phone-error");

// If modal isn't on this page for some reason, abort safely
if (form && phone && errEl) {
  // Live input: auto-convert Arabic/Persian digits
  phone.addEventListener("input", () => {
    const before = phone.value;
    const containsArabic = /[\u0660-\u0669\u06F0-\u06F9]/.test(before);

    if (!ALLOW_ARABIC_INPUT && containsArabic) {
      phone.setCustomValidity("ÿßŸÉÿ™ÿ® ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿä (0-9) ŸÅŸÇÿ∑.");
      errEl.textContent = "ÿßŸÉÿ™ÿ® ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿä (0-9) ŸÅŸÇÿ∑.";
      return;
    }

    phone.setCustomValidity("");
    errEl.textContent = "";

    const converted = normalizeArabicDigits(before);
    if (converted !== before) phone.value = converted;
  });

  // Submit: normalize ‚Üí validate (do NOT preventDefault here if valid)
  form.addEventListener("submit", (e) => {
    const normalized = normalizeToEgMobile(phone.value);
    phone.value = normalized; // send normalized value to backend

    phone.setCustomValidity("");
    errEl.textContent = "";

    if (!EG_MOBILE_RE.test(normalized)) {
      e.preventDefault();
      const msg = "ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖ ŸÖŸàÿ®ÿßŸäŸÑ ŸÖÿµÿ±Ÿä ÿµÿ≠Ÿäÿ≠ (ŸÖÿ´ÿßŸÑ: 01012345678).";
      phone.setCustomValidity(msg);
      errEl.textContent = msg;
      phone.reportValidity();
    }
  });
}


</script>

</body>
</html>



  
